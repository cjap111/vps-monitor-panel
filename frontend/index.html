<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器监控面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-online { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .status-offline { background-color: #e74c3c; box-shadow: 0 0 8px #e74c3c; }
        .card { background-color: #2c2c2c; border: 1px solid #3d3d3d; transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .progress-bar-bg { background-color: #444; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2c2c2c; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .icon-btn { background: rgba(255,255,255,0.1); border-radius: 50%; padding: 4px; transition: background 0.2s; }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }

        /* Custom styles to prevent server name overflow */
        /* Make the name container take available space and allow truncation */
        .card .server-name-container {
            flex-grow: 1; /* Allows it to take available space */
            min-width: 0; /* Prevents overflow issues in flex container */
            margin-right: 8px; /* Add some space between name and buttons */
        }

        /* Ensure truncate works well within its flex container */
        .card .text-lg.font-bold.text-white.truncate {
            min-width: 0; /* Important for truncation to work in flex items */
        }

        /* Styles for the detail modal to control height */
        /* Make the modal content itself a flex container and set its max-height */
        #serverDetailModal > div { /* Target the inner modal content div */
            max-height: 90vh; /* Set a maximum height for the modal itself */
            display: flex;
            flex-direction: column;
        }

        .detail-modal-scroll-content { /* New class for the scrollable part */
            flex-grow: 1; /* Allow this part to grow and take available space */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 1rem; /* Add some padding for scrollbar if needed */
        }

        /* Chart container height to prevent infinite stretching */
        .chart-container {
            position: relative; /* Needed for chart.js responsiveness */
            height: 200px; /* Fixed height for the chart */
            width: 100%; /* Ensure it takes full width of its grid column */
        }

        /* Make canvas responsive within its container */
        .chart-container canvas {
            max-width: 100%;
            height: 100%; /* Important for canvas to respect container height */
        }
    </style>
</head>
<body class="text-gray-200">
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M12 1a11 11 0 1 0 0 22 11 11 0 0 0 0-22V1z"/><path d="M12 5a7 7 0 1 0 0 14 7 7 0 0 0 0-14z"/><path d="M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-white">服务器状态监控面板</h1>
            </div>
            <button id="addServerBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition-transform duration-200 transform hover:scale-105">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span>添加服务器</span>
            </button>
        </header>
        <main id="server-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="col-span-full text-center text-gray-400 p-8">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>正在加载服务器数据...</p>
            </div>
            <!-- Error Display -->
            <div id="error-display" class="col-span-full text-center text-red-500 p-8 hidden">
                <p class="font-bold mb-2">加载数据失败！</p>
                <p class="text-sm">请检查后端服务是否正常运行，以及网络连接和防火墙设置。</p>
                <p id="error-message-content" class="text-xs mt-2 text-red-400"></p>
            </div>
        </main>
    </div>

    <!-- Server Card Template -->
    <template id="server-card-template">
        <div class="card rounded-lg p-5 flex flex-col space-y-4" data-server-id="">
            <div class="flex justify-between items-start">
                <div class="server-name-container"> <!-- Added a wrapper for server name -->
                    <h2 class="text-lg font-bold text-white truncate" data-id="name">服务器名称</h2>
                    <div class="text-xs text-gray-400 flex items-center space-x-2 mt-1">
                         <i data-lucide="map-pin" class="w-4 h-4"></i>
                        <span data-id="location">位置</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2 flex-shrink-0"> <!-- Added flex-shrink-0 to buttons container -->
                    <div class="flex items-center">
                        <span class="status-dot" data-id="status-dot"></span>
                        <span class="font-medium text-sm" data-id="status-text"></span>
                    </div>
                    <button class="icon-btn text-gray-300" data-action="settings"><i data-lucide="settings-2" class="w-5 h-5"></i></button>
                    <button class="icon-btn text-red-500" data-action="delete"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            </div>

            <div class="text-xs text-gray-400 flex items-center space-x-2">
                <i data-lucide="ubuntu" class="w-4 h-4"></i>
                <span data-id="os">Ubuntu 22.04 LTS</span>
            </div>
            
            <div class="space-y-4 pt-2">
                <div class="resource-item">
                    <div class="flex justify-between text-sm mb-1"><span>CPU</span><span class="font-mono" data-id="cpu-usage">0%</span></div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full progress-bar" data-id="cpu-bar" style="width: 0%"></div></div>
                </div>
                <div class="resource-item">
                    <div class="flex justify-between text-sm mb-1"><span>内存</span><span class="font-mono text-xs" data-id="mem-usage">0 MB / 0 MB</span></div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-purple-500 h-2.5 rounded-full progress-bar" data-id="mem-bar" style="width: 0%"></div></div>
                </div>
                <div class="resource-item">
                    <div class="flex justify-between text-sm mb-1"><span>硬盘</span><span class="font-mono text-xs" data-id="disk-usage">0 GB / 0 GB</span></div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full progress-bar" data-id="disk-bar" style="width: 0%"></div></div>
                </div>
            </div>
            <div class="pt-4 border-t border-gray-700/50 flex flex-col space-y-2">
                <div class="flex justify-between text-sm text-gray-300">
                    <div class="flex items-center space-x-2"><i data-lucide="arrow-down-circle" class="w-4 h-4 text-cyan-400"></i><span class="font-mono" data-id="net-down">0 KB/s</span></div>
                    <div class="flex items-center space-x-2"><i data-lucide="arrow-up-circle" class="w-4 h-4 text-red-400"></i><span class="font-mono" data-id="net-up">0 KB/s</span></div>
                </div>
                <div class="text-xs text-gray-500 flex items-center space-x-2"><i data-lucide="clock" class="w-4 h-4"></i><span data-id="uptime">在线 0 天</span></div>
            </div>
            <div class="pt-3 mt-3 border-t border-gray-700/50 text-xs text-gray-400 space-y-1">
                <div class="flex justify-between items-center">
                    <span class="flex items-center space-x-2 font-medium"><i data-lucide="bar-chart-3" class="w-4 h-4"></i><span>总流量</span></span>
                    <span class="text-gray-500" data-id="reset-info">每月1日重置</span>
                </div>
                <div class="flex justify-between items-center pl-1">
                    <span class="flex items-center space-x-1.5 text-red-400"><i data-lucide="arrow-up" class="w-3 h-3"></i><span data-id="total-net-up" class="font-mono">0 GB</span></span>
                    <span class="flex items-center space-x-1.5 text-cyan-400"><i data-lucide="arrow-down" class="w-3 h-3"></i><span class="font-mono">0 GB</span></span>
                </div>
                 <!-- 新增的到期日期显示 -->
                <div class="flex justify-between items-center pl-1 pt-1">
                    <span class="flex items-center space-x-1.5 text-orange-300"><i data-lucide="calendar" class="w-3 h-3"></i><span data-id="expiration-info" class="font-mono"></span></span>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Add/Edit Server Modal (Consolidated) -->
    <div id="addServerModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-[#2c2c2c] rounded-lg shadow-xl p-8 w-full max-w-lg m-4 border border-gray-600">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold text-white">添加新服务器</h3>
                <button data-action="close" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <p class="text-sm text-gray-400 mb-6">请复制以下一键安装命令到需要被监控的服务器上执行。</p>
            <div class="bg-black rounded-md p-4 mb-6">
                <pre class="text-sm text-green-400 overflow-x-auto"><code id="installCommand">...</code></pre>
            </div>
             <div class="flex justify-end">
                 <button data-action="close" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">关闭</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="serverSettingsModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-[#2c2c2c] rounded-lg shadow-xl p-8 w-full max-w-lg m-4 border border-gray-600">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">服务器设置</h3>
                <button data-action="close" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="serverSettingsForm">
                <input type="hidden" id="settingServerId">
                <div class="space-y-4">
                    <div>
                        <label for="settingTotalNetUp" class="block text-sm font-medium text-gray-300 mb-2">累计上传流量 (GB)</label>
                        <input type="number" step="0.01" id="settingTotalNetUp" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="settingTotalNetDown" class="block text-sm font-medium text-gray-300 mb-2">累计下载流量 (GB)</label>
                        <input type="number" step="0.01" id="settingTotalNetDown" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="settingResetDay" class="block text-sm font-medium text-gray-300 mb-2">流量重置日 (1-28)</label>
                        <input type="number" min="1" max="28" id="settingResetDay" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <!-- 新增的密码输入框 -->
                    <div>
                        <label for="settingsPassword" class="block text-sm font-medium text-gray-300 mb-2">被控端安装密码</label>
                        <input type="password" id="settingsPassword" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <!-- 新增的到期日期输入框 -->
                    <div>
                        <label for="settingExpirationDate" class="block text-sm font-medium text-gray-300 mb-2">到期日期</label>
                        <input type="date" id="settingExpirationDate" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" data-action="close" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">保存设置</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteServerModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-[#2c2c2c] rounded-lg shadow-xl p-8 w-full max-w-md m-4 border border-red-500/50">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-red-500">确认删除</h3>
                <button data-action="close" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <p class="text-gray-300 mb-6">您确定要删除服务器 <strong id="deleteServerName" class="text-yellow-400"></strong> 吗？此操作不可逆。</p>
            <form id="deleteServerForm">
                <input type="hidden" id="deleteServerId">
                <div>
                    <label for="deletePassword" class="block text-sm font-medium text-gray-300 mb-2">请输入删除密码</label>
                    <input type="password" id="deletePassword" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-red-500 focus:border-red-500" required>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" data-action="close" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">确认删除</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Modal (New) -->
    <div id="messageModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-[#2c2c2c] rounded-lg shadow-xl p-8 w-full max-w-sm m-4 border border-gray-600">
            <div class="flex justify-between items-center mb-4">
                <h3 id="messageModalTitle" class="text-xl font-bold text-white">消息</h3>
                <button data-action="close-message" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <p id="messageModalContent" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end">
                <button data-action="close-message" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">确定</button>
            </div>
        </div>
    </div>

    <!-- Server Detail Modal -->
    <div id="serverDetailModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop overflow-y-auto">
        <div class="bg-[#2c2c2c] rounded-lg shadow-xl p-8 w-full max-w-2xl m-4 border border-gray-600 flex flex-col">
            <div class="flex justify-between items-start mb-6 flex-shrink-0">
                <div>
                    <h3 id="detailServerName" class="text-2xl font-bold text-white mb-2">服务器详情</h3>
                    <div class="text-sm text-gray-400 flex items-center space-x-2">
                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                        <span id="detailServerLocation"></span>
                        <span id="detailServerOS" class="ml-4"></span>
                    </div>
                </div>
                <button data-action="close-detail" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <!-- Scrollable content wrapper -->
            <div class="flex-grow overflow-y-auto pr-2 detail-modal-scroll-content">
                <div class="space-y-6">
                    <!-- CPU -->
                    <div>
                        <div class="flex justify-between text-sm mb-1 text-gray-300">
                            <span>CPU 使用率</span>
                            <span class="font-mono text-white" id="detailCpuUsage">0%</span>
                        </div>
                        <div class="w-full progress-bar-bg rounded-full h-3">
                            <div class="bg-blue-500 h-3 rounded-full progress-bar" id="detailCpuBar" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-400 mt-2">
                            <i data-lucide="cpu" class="w-4 h-4 inline-block align-middle mr-2"></i>
                            <span id="detailCpuModel">CPU 型号: N/A</span>
                        </div>
                    </div>

                    <!-- Memory -->
                    <div>
                        <div class="flex justify-between text-sm mb-1 text-gray-300">
                            <span>内存使用</span>
                            <span class="font-mono text-white" id="detailMemUsage">0 MB / 0 MB</span>
                        </div>
                        <div class="w-full progress-bar-bg rounded-full h-3">
                            <div class="bg-purple-500 h-3 rounded-full progress-bar" id="detailMemBar" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-400 mt-2">
                             <i data-lucide="hard-drive" class="w-4 h-4 inline-block align-middle mr-2"></i>
                            <span id="detailMemModel">内存型号: N/A</span>
                        </div>
                    </div>

                    <!-- Disk -->
                    <div>
                        <div class="flex justify-between text-sm mb-1 text-gray-300">
                            <span>硬盘使用</span>
                            <span class="font-mono text-white" id="detailDiskUsage">0 GB / 0 GB</span>
                        </div>
                        <div class="w-full progress-bar-bg rounded-full h-3">
                            <div class="bg-green-500 h-3 rounded-full progress-bar" id="detailDiskBar" style="width: 0%"></div>
                        </div>
                         <div class="text-sm text-gray-400 mt-2">
                            <i data-lucide="hard-drive" class="w-4 h-4 inline-block align-middle mr-2"></i>
                            <span id="detailDiskModel">硬盘型号: N/A</span>
                        </div>
                    </div>

                    <!-- Network Charts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div class="chart-container">
                            <h4 class="text-lg font-semibold text-gray-200 mb-3" id="downloadChartTitle">下载速度</h4>
                            <canvas id="downloadChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4 class="text-lg font-semibold text-gray-200 mb-3" id="uploadChartTitle">上传速度</h4>
                            <canvas id="uploadChart"></canvas>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-gray-700/50 flex justify-between items-center text-sm text-gray-300">
                        <div class="flex items-center space-x-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i><span>总上传: <span id="detailTotalNetUp" class="font-mono text-red-400">0 GB</span></span></div>
                        <div class="flex items-center space-x-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i><span>总下载: <span id="detailTotalNetDown" class="font-mono text-cyan-400">0 GB</span></span></div>
                    </div>
                    <div class="text-xs text-gray-500 flex justify-between items-center">
                        <span class="flex items-center space-x-2"><i data-lucide="clock" class="w-4 h-4"></i><span id="detailUptime">在线 0 天</span></span>
                        <span class="flex items-center space-x-2"><i data-lucide="repeat" class="w-4 h-4"></i><span id="detailResetInfo">每月1日重置</span></span>
                    </div>
                    <div class="pt-1 text-xs text-gray-400 flex items-center space-x-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i><span id="detailExpirationInfo" class="font-mono"></span>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end mt-8 flex-shrink-0">
                <button data-action="close-detail" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">关闭</button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            const serverGrid = document.getElementById('server-grid');
            const template = document.getElementById('server-card-template');
            
            let servers = [];
            // API endpoint will automatically use the current page's domain
            const API_ENDPOINT = `${window.location.protocol}//${window.location.host}/api`;
            const GB_IN_BYTES = 1024 * 1024 * 1024;
            const MB_IN_BYTES = 1024 * 1024;

            // Chart.js instances and data history
            let downloadChartInstance = null;
            let uploadChartInstance = null;
            const chartDataPoints = 60; // Keep history for 60 seconds (assuming 1s interval)
            let networkHistory = {
                labels: Array.from({length: chartDataPoints}, (_, i) => i % 10 === 0 ? `-${chartDataPoints - i}s` : ''),
                download: Array(chartDataPoints).fill(0),
                upload: Array(chartDataPoints).fill(0)
            };
            let detailViewInterval = null; // Interval for detail view updates

            // Function to display custom messages instead of alert()
            function showMessage(title, message) {
                const messageModalTitleElement = document.getElementById('messageModalTitle');
                const messageModalContentElement = document.getElementById('messageModalContent');
                const messageModalElement = document.getElementById('messageModal');

                if (messageModalTitleElement) messageModalTitleElement.textContent = title;
                if (messageModalContentElement) messageModalContentElement.textContent = message;
                if (messageModalElement) messageModalElement.style.display = 'flex';
                lucide.createIcons(); // Re-create icons if the modal content changes
            }

            // Enhanced formatBytes to dynamically choose unit (Bytes, KB, MB, GB, TB)
            const formatBytes = (bytes, decimals = 2) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)); // Return just the number for dynamic speed
            };
            
            // New formatSpeed function to return value and unit separately
            const formatSpeedWithUnit = (bytes) => {
                if (bytes === 0) return { value: 0, unit: 'B/s' };
                const k = 1024;
                const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s', 'TB/s'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return { value: parseFloat((bytes / Math.pow(k, i)).toFixed(2)), unit: sizes[i] };
            };


            // Function to update a single server card
            function updateServerCard(cardElement, server) {
                // Update basic info
                const nameElement = cardElement.querySelector('[data-id="name"]');
                if (nameElement) nameElement.textContent = server.name;

                const locationElement = cardElement.querySelector('[data-id="location"]');
                if (locationElement) locationElement.textContent = server.location;

                const osElement = cardElement.querySelector('[data-id="os"]');
                if (osElement) osElement.textContent = server.os;

                // Update status dot and text
                const statusDot = cardElement.querySelector('[data-id="status-dot"]');
                const statusText = cardElement.querySelector('[data-id="status-text"]');
                
                // Ensure statusDot and statusText exist before modifying classList/textContent
                if (statusDot && statusText) {
                    if (server.online) {
                        statusDot.classList.remove('status-offline');
                        statusDot.classList.add('status-online');
                        statusText.textContent = '在线';
                        statusText.classList.remove('text-red-400');
                        statusText.classList.add('text-green-400');
                    } else {
                        statusDot.classList.remove('status-online');
                        statusDot.classList.add('status-offline');
                        statusText.textContent = '离线';
                        statusText.classList.remove('text-green-400');
                        statusText.classList.add('text-red-400');
                    }
                }

                // Update CPU
                const cpuUsage = server.cpu ? server.cpu.toFixed(1) : 0;
                const cpuUsageElement = cardElement.querySelector('[data-id="cpu-usage"]');
                const cpuBarElement = cardElement.querySelector('[data-id="cpu-bar"]');
                if (cpuUsageElement) cpuUsageElement.textContent = `${cpuUsage}%`;
                if (cpuBarElement) cpuBarElement.style.width = `${cpuUsage}%`;

                // Update Memory
                const memUsed = server.mem ? server.mem.used : 0;
                const memTotal = server.mem ? server.mem.total : 0;
                const memUsagePercent = memTotal > 0 ? (memUsed / memTotal * 100).toFixed(1) : 0;
                const memUsageElement = cardElement.querySelector('[data-id="mem-usage"]');
                const memBarElement = cardElement.querySelector('[data-id="mem-bar"]');
                if (memUsageElement) memUsageElement.textContent = `${memUsed} MB / ${memTotal} MB`;
                if (memBarElement) memBarElement.style.width = `${memUsagePercent}%`;

                // Update Disk
                const diskUsedMB = server.disk ? server.disk.used : 0;
                const diskTotalMB = server.disk ? server.disk.total : 0;
                
                // Convert MB to GB for display
                const diskUsedGB = (diskUsedMB / 1024).toFixed(2); // Keep 2 decimal places for GB
                const diskTotalGB = (diskTotalMB / 1024).toFixed(2); // Keep 2 decimal places for GB

                const diskUsagePercent = diskTotalMB > 0 ? (diskUsedMB / diskTotalMB * 100).toFixed(1) : 0;
                const diskUsageElement = cardElement.querySelector('[data-id="disk-usage"]');
                const diskBarElement = cardElement.querySelector('[data-id="disk-bar"]');
                if (diskUsageElement) diskUsageElement.textContent = `${diskUsedGB} GB / ${diskTotalGB} GB`;
                if (diskBarElement) diskBarElement.style.width = `${diskUsagePercent}%`;

                // Update Network Speed with dynamic units
                const netDown = server.net ? server.net.down : 0;
                const netUp = server.net ? server.net.up : 0;
                const formattedNetDown = formatSpeedWithUnit(netDown);
                const formattedNetUp = formatSpeedWithUnit(netUp);

                const netDownElement = cardElement.querySelector('[data-id="net-down"]');
                const netUpElement = cardElement.querySelector('[data-id="net-up"]');
                if (netDownElement) netDownElement.textContent = `${formattedNetDown.value} ${formattedNetDown.unit}`;
                if (netUpElement) netUpElement.textContent = `${formattedNetUp.value} ${formattedNetUp.unit}`;


                // Update Uptime
                const startTime = server.startTime;
                const uptimeElement = cardElement.querySelector('[data-id="uptime"]');
                if (uptimeElement) {
                    if (startTime) {
                        const uptimeMs = Date.now() - startTime;
                        const uptimeDays = Math.floor(uptimeMs / (1000 * 60 * 60 * 24));
                        uptimeElement.textContent = `在线 ${uptimeDays} 天`;
                    } else {
                        uptimeElement.textContent = `在线 0 天`;
                    }
                }

                // Update Total Net Traffic
                const totalNetUpGB = (server.totalNet.up / GB_IN_BYTES).toFixed(2);
                const totalNetDownGB = (server.totalNet.down / GB_IN_BYTES).toFixed(2);
                const totalNetUpElement = cardElement.querySelector('[data-id="total-net-up"]');
                const totalNetDownElement = cardElement.querySelector('[data-id="total-net-down"]');
                const resetInfoElement = cardElement.querySelector('[data-id="reset-info"]');

                if (totalNetUpElement) totalNetUpElement.textContent = `${totalNetUpGB} GB`;
                if (totalNetDownElement) totalNetDownElement.textContent = `${totalNetDownGB} GB`;
                if (resetInfoElement) resetInfoElement.textContent = `每月${server.resetDay}日重置`;

                // Update Expiration Date and calculate remaining days
                const expirationInfo = cardElement.querySelector('[data-id="expiration-info"]');
                if (expirationInfo) { // Ensure expirationInfo element exists
                    if (server.expirationDate) {
                        const expDate = new Date(server.expirationDate);
                        const now = new Date();
                        now.setHours(0, 0, 0, 0); // Normalize 'now' to start of day
                        expDate.setHours(0, 0, 0, 0); // Normalize 'expDate' to start of day

                        const diffTime = expDate.getTime() - now.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays > 0) {
                            expirationInfo.textContent = `剩余 ${diffDays} 天`;
                            expirationInfo.classList.remove('text-red-400', 'text-orange-400'); // Remove all before adding
                            if (diffDays <= 7) {
                                expirationInfo.classList.add('text-orange-400'); // Orange for expiring soon
                            } else {
                                expirationInfo.classList.add('text-green-400'); // Green for normal
                            }
                        } else if (diffDays === 0) {
                            expirationInfo.textContent = `今天到期`;
                            expirationInfo.classList.remove('text-green-400', 'text-red-400');
                            expirationInfo.classList.add('text-orange-400');
                        } else {
                            expirationInfo.textContent = `已过期 ${Math.abs(diffDays)} 天`;
                            expirationInfo.classList.remove('text-orange-400', 'text-green-400');
                            expirationInfo.classList.add('text-red-400');
                        }
                    } else {
                        expirationInfo.textContent = '到期日期: 未设置';
                        expirationInfo.classList.remove('text-orange-400', 'text-red-400', 'text-green-400');
                        expirationInfo.classList.add('text-gray-400');
                    }
                }
            }


            async function fetchAndRenderServers() {
                const loadingIndicator = document.getElementById('loading-indicator');
                const errorDisplay = document.getElementById('error-display');
                const errorMessageContent = document.getElementById('error-message-content');

                // Show loading indicator, hide error
                if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                if (errorDisplay) errorDisplay.classList.add('hidden');
                if (errorMessageContent) errorMessageContent.textContent = ''; // Clear previous error

                try {
                    const response = await fetch(`${API_ENDPOINT}/servers`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP Error: ${response.status} - ${errorText || response.statusText}`);
                    }
                    const serverList = await response.json();
                    servers = serverList;
                    renderAllServers();
                    console.log(`[${new Date().toISOString()}] Successfully fetched and rendered ${serverList.length} servers.`); // Added success log
                } catch (error) {
                    console.error(`[${new Date().toISOString()}] Error fetching server list:`, error); // Added detailed error log
                    if (errorDisplay) errorDisplay.classList.remove('hidden');
                    if (errorMessageContent) errorMessageContent.textContent = error.message;
                    if (serverGrid) serverGrid.innerHTML = ''; // Clear servers if error
                } finally {
                    if (loadingIndicator) loadingIndicator.classList.add('hidden'); // Always hide loading indicator
                }
            }

            function renderAllServers() {
                if (serverGrid) serverGrid.innerHTML = ''; // Clear existing cards

                if (servers.length === 0) {
                    const noServersMessage = document.createElement('div');
                    noServersMessage.className = 'col-span-full text-center text-gray-400 p-8';
                    noServersMessage.innerHTML = '<p>暂无服务器数据。请添加服务器并确保Agent已成功安装。</p>';
                    if (serverGrid) serverGrid.appendChild(noServersMessage);
                } else {
                    // Sort: online first, then offline
                    servers.sort((a, b) => (b.online ? 1 : 0) - (a.online ? 1 : 0));
                    servers.forEach(server => {
                        const card = template.content.cloneNode(true).querySelector('.card');
                        card.dataset.serverId = server.id;
                        updateServerCard(card, server);
                        if (serverGrid) serverGrid.appendChild(card);
                    });
                }
                lucide.createIcons();
            }
            
            const addModal = document.getElementById('addServerModal');
            const settingsModal = document.getElementById('serverSettingsModal');
            const deleteModal = document.getElementById('deleteServerModal');
            const messageModal = document.getElementById('messageModal'); // Get the new message modal
            const detailModal = document.getElementById('serverDetailModal'); // Get the new detail modal

            document.getElementById('addServerBtn').addEventListener('click', () => {
                const command = `curl -sL https://raw.githubusercontent.com/cjap111/vps-monitor-panel/main/install.sh | bash -s -- 2`;
                if (document.getElementById('installCommand')) {
                    document.getElementById('installCommand').textContent = command;
                }
                if (addModal) addModal.style.display = 'flex';
                lucide.createIcons();
            });

            document.body.addEventListener('click', (e) => {
                const actionTarget = e.target.closest('[data-action]');
                const card = e.target.closest('[data-server-id]');

                // Handle closing modals
                if (actionTarget) {
                    const action = actionTarget.dataset.action;
                    const modal = actionTarget.closest('.modal-backdrop');

                    if (action === 'close' && modal) {
                        modal.style.display = 'none';
                    } else if (action === 'close-message' && messageModal) {
                        messageModal.style.display = 'none';
                    } else if (action === 'close-detail' && detailModal) {
                        detailModal.style.display = 'none';
                        clearInterval(detailViewInterval); // Stop refreshing detail data
                        detailViewInterval = null;
                        // Destroy chart instances when modal closes
                        if (downloadChartInstance) {
                            downloadChartInstance.destroy();
                            downloadChartInstance = null;
                        }
                        if (uploadChartInstance) {
                            uploadChartInstance.destroy();
                            uploadChartInstance = null;
                        }
                        // Reset network history
                        networkHistory.labels = Array.from({length: chartDataPoints}, (_, i) => i % 10 === 0 ? `-${chartDataPoints - i}s` : ''),
                        networkHistory.download = Array(chartDataPoints).fill(0),
                        networkHistory.upload = Array(chartDataPoints).fill(0);
                    }
                }
                
                // Handle card clicks for detail view, settings, and delete
                if (card) {
                    const serverId = card.dataset.serverId;
                    // Check if an action button was clicked directly within the card
                    const clickedActionButton = e.target.closest('[data-action="settings"]') || e.target.closest('[data-action="delete"]');

                    if (clickedActionButton) { // If an action button was clicked
                        const action = clickedActionButton.dataset.action;
                        if (action === 'settings') {
                            openSettingsModal(serverId);
                        } else if (action === 'delete') {
                            openDeleteModal(serverId);
                        }
                    } else { // If the card itself was clicked (not an action button inside it)
                        openServerDetailModal(serverId);
                    }
                }
            });

            function openSettingsModal(serverId) {
                const server = servers.find(s => s.id == serverId);
                if (!server) return;
                
                if (document.getElementById('settingServerId')) document.getElementById('settingServerId').value = server.id;
                if (document.getElementById('settingTotalNetUp')) document.getElementById('settingTotalNetUp').value = (server.totalNet.up / GB_IN_BYTES).toFixed(2);
                if (document.getElementById('settingTotalNetDown')) document.getElementById('settingTotalNetDown').value = (server.totalNet.down / GB_IN_BYTES).toFixed(2);
                if (document.getElementById('settingResetDay')) document.getElementById('settingResetDay').value = server.resetDay;
                if (document.getElementById('settingsPassword')) document.getElementById('settingsPassword').value = ''; // Clear password field

                // Set value for expiration date input
                const settingExpirationDateElement = document.getElementById('settingExpirationDate');
                if (settingExpirationDateElement) {
                    if (server.expirationDate) {
                        // Assign ISO format date (e.g., "YYYY-MM-DD") directly to date input
                        settingExpirationDateElement.value = server.expirationDate; // Assuming it's alreadyYYYY-MM-DD from backend
                    } else {
                        settingExpirationDateElement.value = ''; // Clear if not set
                    }
                }

                if (settingsModal) settingsModal.style.display = 'flex';
            }

            function openDeleteModal(serverId) {
                const server = servers.find(s => s.id == serverId);
                if (!server) return;
                
                if (document.getElementById('deleteServerName')) document.getElementById('deleteServerName').textContent = server.name;
                if (document.getElementById('deleteServerId')) document.getElementById('deleteServerId').value = serverId;
                if (deleteModal) deleteModal.style.display = 'flex';
            }

            // Function to open server detail modal
            function openServerDetailModal(serverId) {
                const server = servers.find(s => s.id === serverId);
                if (!server) return;

                // Reset network history for new chart
                networkHistory = {
                    labels: Array.from({length: chartDataPoints}, (_, i) => i % 10 === 0 ? `-${chartDataPoints - i}s` : ''),
                    download: Array(chartDataPoints).fill(0),
                    upload: Array(chartDataPoints).fill(0)
                };

                // Populate initial data for the modal
                updateDetailModalData(server);
                initDetailCharts(); // Initialize charts before first data fetch

                if (detailModal) detailModal.style.display = 'flex';
                lucide.createIcons();

                // Start fetching and updating detail data every second
                if (detailViewInterval) { // Clear existing interval if any
                    clearInterval(detailViewInterval);
                }
                detailViewInterval = setInterval(() => fetchServerDetail(serverId), 1000); // Fetch every 1 second
            }

            // Function to fetch single server detail (for detail modal)
            async function fetchServerDetail(serverId) {
                try {
                    const response = await fetch(`${API_ENDPOINT}/servers`); // Fetch all servers, then find the specific one
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP Error: ${response.status} - ${errorText || response.statusText}`);
                    }
                    const serverList = await response.json();
                    const server = serverList.find(s => s.id === serverId);

                    if (server) {
                        updateDetailModalData(server);
                        updateDetailCharts(server);
                    } else {
                        // Server might have been deleted or gone offline
                        clearInterval(detailViewInterval);
                        if (detailModal) detailModal.style.display = 'none';
                        showMessage('服务器已移除', '您尝试查看的服务器已不再可用。');
                        fetchAndRenderServers(); // Refresh main grid
                    }
                } catch (error) {
                    console.error(`Error fetching server detail for ${serverId}:`, error);
                    // Optionally display an error within the modal or close it
                    clearInterval(detailViewInterval);
                    if (detailModal) detailModal.style.display = 'none';
                    showMessage('加载失败', `无法加载服务器详细信息: ${error.message}`);
                    fetchAndRenderServers(); // Refresh main grid
                }
            }

            // Function to update static data in detail modal
            function updateDetailModalData(server) {
                // Get elements that are common to both main card and detail modal
                // These elements should exist in the detail modal, but might not in the main card template
                const detailServerNameElement = document.getElementById('detailServerName');
                if (detailServerNameElement) detailServerNameElement.textContent = server.name;

                const detailServerLocationElement = document.getElementById('detailServerLocation');
                if (detailServerLocationElement) detailServerLocationElement.textContent = server.location;

                const detailServerOSElement = document.getElementById('detailServerOS');
                if (detailServerOSElement) detailServerOSElement.textContent = server.os;
                
                // Add CPU Model - Check if element exists before accessing
                const detailCpuModelElement = document.getElementById('detailCpuModel');
                if (detailCpuModelElement) {
                    detailCpuModelElement.textContent = `CPU 型号: ${server.cpuModel || 'N/A'}`;
                }

                // Add Memory Model - Check if element exists before accessing
                const detailMemModelElement = document.getElementById('detailMemModel');
                if (detailMemModelElement) {
                    detailMemModelElement.textContent = `内存型号: ${server.memModel || 'N/A'}`;
                }

                // Add Disk Model - Check if element exists before accessing
                const detailDiskModelElement = document.getElementById('detailDiskModel');
                if (detailDiskModelElement) {
                    detailDiskModelElement.textContent = `硬盘型号: ${server.diskModel || 'N/A'}`;
                }


                const detailCpuUsage = server.cpu ? server.cpu.toFixed(1) : 0;
                const detailCpuUsageElement = document.getElementById('detailCpuUsage');
                const detailCpuBarElement = document.getElementById('detailCpuBar');
                if (detailCpuUsageElement) detailCpuUsageElement.textContent = `${detailCpuUsage}%`;
                if (detailCpuBarElement) detailCpuBarElement.style.width = `${detailCpuUsage}%`;

                const detailMemUsed = server.mem ? server.mem.used : 0;
                const detailMemTotal = server.mem ? server.mem.total : 0;
                const detailMemUsagePercent = memTotal > 0 ? (memUsed / memTotal * 100).toFixed(1) : 0;
                const detailMemUsageElement = document.getElementById('detailMemUsage');
                const detailMemBarElement = document.getElementById('detailMemBar');
                if (memUsageElement) memUsageElement.textContent = `${memUsed} MB / ${memTotal} MB`;
                if (memBarElement) memBarElement.style.width = `${memUsagePercent}%`;

                const detailDiskUsedMB = server.disk ? server.disk.used : 0;
                const detailDiskTotalMB = server.disk ? server.disk.total : 0;
                const detailDiskUsedGB = (detailDiskUsedMB / 1024).toFixed(2);
                const detailDiskTotalGB = (detailDiskTotalMB / 1024).toFixed(2);
                const detailDiskUsagePercent = detailDiskTotalMB > 0 ? (detailDiskUsedMB / detailDiskTotalMB * 100).toFixed(1) : 0;
                const detailDiskUsageElement = document.getElementById('detailDiskUsage');
                const detailDiskBarElement = document.getElementById('detailDiskBar');
                if (detailDiskUsageElement) detailDiskUsageElement.textContent = `${diskUsedGB} GB / ${diskTotalGB} GB`;
                if (detailDiskBarElement) detailDiskBarElement.style.width = `${diskUsagePercent}%`;


                const detailTotalNetUpGB = (server.totalNet.up / GB_IN_BYTES).toFixed(2);
                const detailTotalNetDownGB = (server.totalNet.down / GB_IN_BYTES).toFixed(2);
                const detailTotalNetUpElement = document.getElementById('detailTotalNetUp');
                const detailTotalNetDownElement = document.getElementById('detailTotalNetDown');
                const detailResetInfoElement = document.getElementById('detailResetInfo');

                if (detailTotalNetUpElement) detailTotalNetUpElement.textContent = `${detailTotalNetUpGB} GB`;
                if (detailTotalNetDownElement) detailTotalNetDownElement.textContent = `${detailTotalNetDownGB} GB`;
                if (detailResetInfoElement) detailResetInfoElement.textContent = `每月${server.resetDay}日重置`;

                const detailUptimeElement = document.getElementById('detailUptime');
                if (detailUptimeElement) {
                    if (server.startTime) {
                        const uptimeMs = Date.now() - server.startTime;
                        const uptimeDays = Math.floor(uptimeMs / (1000 * 60 * 60 * 24));
                        detailUptimeElement.textContent = `在线 ${uptimeDays} 天`;
                    } else {
                        detailUptimeElement.textContent = `在线 0 天`;
                    }
                }

                const detailExpirationInfo = document.getElementById('detailExpirationInfo');
                if (detailExpirationInfo) { // Ensure expirationInfo element exists
                    if (server.expirationDate) {
                        const expDate = new Date(server.expirationDate);
                        const now = new Date();
                        now.setHours(0, 0, 0, 0); // Normalize 'now' to start of day
                        expDate.setHours(0, 0, 0, 0); // Normalize 'expDate' to start of day

                        const diffTime = expDate.getTime() - now.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays > 0) {
                            detailExpirationInfo.textContent = `到期日期: 剩余 ${diffDays} 天`;
                            detailExpirationInfo.classList.remove('text-red-400', 'text-orange-400'); // Remove all before adding
                            if (diffDays <= 7) {
                                detailExpirationInfo.classList.add('text-orange-400'); // Orange for expiring soon
                            } else {
                                detailExpirationInfo.classList.add('text-green-400'); // Green for normal
                            }
                        } else if (diffDays === 0) {
                            detailExpirationInfo.textContent = `到期日期: 今天到期`;
                            detailExpirationInfo.classList.remove('text-green-400', 'text-red-400');
                            detailExpirationInfo.classList.add('text-orange-400');
                        } else {
                            detailExpirationInfo.textContent = `到期日期: 已过期 ${Math.abs(diffDays)} 天`;
                            detailExpirationInfo.classList.remove('text-orange-400', 'text-green-400');
                            detailExpirationInfo.classList.add('text-red-400');
                        }
                    } else {
                        detailExpirationInfo.textContent = '到期日期: 未设置';
                        detailExpirationInfo.classList.remove('text-orange-400', 'text-red-400', 'text-green-400');
                        detailExpirationInfo.classList.add('text-gray-400');
                    }
                }
            }

            // Function to initialize charts in detail modal
            function initDetailCharts() {
                const downloadCtx = document.getElementById('downloadChart').getContext('2d');
                const uploadCtx = document.getElementById('uploadChart').getContext('2d');

                // Destroy existing instances if they exist
                if (downloadChartInstance) downloadChartInstance.destroy();
                if (uploadChartInstance) uploadChartInstance.destroy();

                const commonChartOptions = { // Renamed to avoid repetition
                    animation: false, // Disable animation for real-time updates
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category', // Use 'category' for labels array
                            labels: networkHistory.labels,
                            grid: { color: '#3d3d3d' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3d3d3d' },
                            ticks: {
                                color: '#888',
                                callback: function(value, index, values) {
                                    // Custom tick label to show dynamic unit
                                    // 'this' refers to the scale instance
                                    const unit = this.options.unit || ''; 
                                    return `${value} ${unit.replace('/s', '')}`; // Remove /s for Y-axis tick
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    // Custom tooltip label to show dynamic unit
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    const unit = context.chart.options.scales.y.unit || ''; // Get unit from y-axis options
                                    return label + `${value} ${unit}`;
                                }
                            }
                        }
                    }
                };

                // Initialize download chart
                downloadChartInstance = new Chart(downloadCtx, {
                    type: 'line',
                    data: {
                        labels: networkHistory.labels,
                        datasets: [{
                            label: '下载速度', // Label for tooltip
                            data: networkHistory.download,
                            borderColor: '#06b6d4', // Cyan 500
                            backgroundColor: 'rgba(6, 182, 212, 0.2)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        ...commonChartOptions,
                        scales: {
                            ...commonChartOptions.scales,
                            y: {
                                ...commonChartOptions.scales.y,
                                unit: 'B/s' // Initial unit for download Y-axis
                            }
                        }
                    }
                });

                uploadChartInstance = new Chart(uploadCtx, {
                    type: 'line',
                    data: {
                        labels: networkHistory.labels,
                        datasets: [{
                            label: '上传速度', // Label for tooltip
                            data: networkHistory.upload,
                            borderColor: '#ef4444', // Red 500
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        ...commonChartOptions,
                        scales: {
                            ...commonChartOptions.scales,
                            y: {
                                ...commonChartOptions.scales.y,
                                unit: 'B/s' // Initial unit for upload Y-axis
                            }
                        }
                    }
                });
            }

            // Function to dynamically format speed for charts and update chart titles
            function formatSpeedForChart(bytes) {
                if (bytes === 0) return { value: 0, unit: 'B/s', rawValue: 0 };
                const k = 1024;
                const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s', 'TB/s'];
                let i = 0;
                while (bytes >= k && i < sizes.length - 1) {
                    bytes /= k;
                    i++;
                }
                return { value: parseFloat(bytes.toFixed(2)), unit: sizes[i], rawValue: bytes };
            }

            // Function to update chart data
            function updateDetailCharts(server) {
                const rawDownloadBytes = server.net ? server.net.down : 0;
                const rawUploadBytes = server.net ? server.net.up : 0;

                const formattedDownload = formatSpeedForChart(rawDownloadBytes);
                const formattedUpload = formatSpeedForChart(rawUploadBytes);

                // Update chart titles without units, as unit is now in Y-axis
                const downloadChartTitleElement = document.getElementById('downloadChartTitle');
                if (downloadChartTitleElement) downloadChartTitleElement.textContent = `下载速度`;

                const uploadChartTitleElement = document.getElementById('uploadChartTitle');
                if (uploadChartTitleElement) uploadChartTitleElement.textContent = `上传速度`;


                // Remove oldest data point and add new data point
                networkHistory.download.shift();
                networkHistory.upload.shift();
                networkHistory.download.push(formattedDownload.rawValue); // Push raw value for consistent Y-axis scaling
                networkHistory.upload.push(formattedUpload.rawValue);

                // Update labels to show relative time (e.g., -5s, -4s, ..., 0s)
                networkHistory.labels = Array.from({length: chartDataPoints}, (_, i) => {
                    const diff = chartDataPoints - 1 - i;
                    if (diff === 0) return '0s';
                    if (diff % 10 === 0) return `-${diff}s`;
                    return '';
                });

                if (downloadChartInstance && uploadChartInstance) {
                    // Update Y-axis unit for the charts (used by the callback function)
                    downloadChartInstance.options.scales.y.unit = formattedDownload.unit;
                    uploadChartInstance.options.scales.y.unit = formattedUpload.unit;

                    downloadChartInstance.data.labels = networkHistory.labels;
                    downloadChartInstance.data.datasets[0].data = networkHistory.download;
                    downloadChartInstance.update();

                    uploadChartInstance.data.labels = networkHistory.labels;
                    uploadChartInstance.data.datasets[0].data = networkHistory.upload;
                    uploadChartInstance.update();
                }
            }


            document.getElementById('serverSettingsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const serverId = document.getElementById('settingServerId').value;
                const settingsPassword = document.getElementById('settingsPassword').value; // Get password

                if (!settingsPassword) {
                    showMessage('Input Error', 'Please enter agent installation password!');
                    return;
                }

                // Get expiration date, set to null if empty
                const expirationDateInput = document.getElementById('settingExpirationDate').value;
                // Ensure date is in 'YYYY-MM-DD' format if not null
                const expirationDate = expirationDateInput ? expirationDateInput : null;


                const settings = {
                    totalNetUp: parseFloat(document.getElementById('settingTotalNetUp').value) * GB_IN_BYTES,
                    totalNetDown: parseFloat(document.getElementById('settingTotalNetDown').value) * GB_IN_BYTES,
                    resetDay: parseInt(document.getElementById('settingResetDay').value),
                    password: settingsPassword, // Add password to request body
                    expirationDate: expirationDate // Add expiration date
                };

                try {
                    const response = await fetch(`${API_ENDPOINT}/servers/${serverId}/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    if (response.ok) {
                        showMessage('Success', 'Settings updated successfully!');
                        settingsModal.style.display = 'none';
                        fetchAndRenderServers();
                    } else {
                        const errorText = await response.text();
                        showMessage('Update Failed', `Update failed: ${errorText}`);
                    }
                } catch (error) {
                    showMessage('Request Failed', `Request failed: ${error.message}`);
                }
            });
            
            document.getElementById('deleteServerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const serverId = document.getElementById('deleteServerId').value;
                const password = document.getElementById('deletePassword').value;
                if (!password) {
                    showMessage('Input Error', 'Please enter password!');
                    return;
                }

                try {
                    const response = await fetch(`${API_ENDPOINT}/servers/${serverId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password })
                    });

                    if (response.ok) {
                        showMessage('Success', 'Server deleted successfully!\nPlease note: To completely remove this server, please run the agent uninstallation command on the corresponding physical server.');
                        deleteModal.style.display = 'none';
                        document.getElementById('deletePassword').value = '';
                        fetchAndRenderServers();
                    } else {
                        const errorText = await response.text();
                        showMessage('Delete Failed', `Delete failed: ${errorText}`);
                    }
                } catch (error) {
                    showMessage('Request Failed', `Request failed: ${error.message}`);
                }
            });

            // Initial fetch and render
            fetchAndRenderServers();
            // Refresh data every 5 seconds
            setInterval(fetchAndRenderServers, 5000);
        });
    </script>
</body>
</html>
```

以下是更新后的 `server.js` 代码：


```javascript
require('dotenv').config(); // Load environment variables at the top of the file
const express = require('express');
const cors = require('cors');
const fs = require('fs'); // Import fs module
const path = require('path'); // Import path module
const app = express();
const PORT = 3000;

// Read passwords from environment variables
const DELETE_PASSWORD = process.env.DELETE_PASSWORD;
const AGENT_INSTALL_PASSWORD = process.env.AGENT_INSTALL_PASSWORD; // Agent installation password

if (!DELETE_PASSWORD || !AGENT_INSTALL_PASSWORD) {
    console.error("Error: DELETE_PASSWORD or AGENT_INSTALL_PASSWORD not set in environment variables!");
    process.exit(1);
}

// --- Data Persistence ---
const DB_FILE = path.join(__dirname, 'server_data.json');
let serverDataStore = {};

// Load data on startup
try {
    if (fs.existsSync(DB_FILE)) {
        const data = fs.readFileSync(DB_FILE, 'utf8');
        serverDataStore = JSON.parse(data);
        console.log(`Data successfully loaded from ${DB_FILE}.`);
    }
} catch (err) {
    console.error("Error loading data from file:", err);
}

// Save data to file
function saveData() {
    try {
        fs.writeFileSync(DB_FILE, JSON.stringify(serverDataStore, null, 2));
    } catch (err) {
        console.error("Error saving data to file:", err);
    }
}
// --- End Data Persistence ---

app.use(cors());
app.use(express.json({limit: '1mb'}));
app.use(express.urlencoded({ extended: true, limit: '1mb' })); // Add urlencoded middleware for robustness

// --- Routes ---

// A simple root route to check if the backend is alive
app.get('/', (req, res) => {
    console.log(`[${new Date().toISOString()}] Root path accessed.`);
    res.status(200).send('Monitor Backend is running!');
});

// POST /api/report - Receive monitoring data from agents
app.post('/api/report', (req, res) => {
    console.log(`[${new Date().toISOString()}] Received report from server ID: ${req.body.id}`); // Added log for incoming reports
    const data = req.body;
    if (!data.id) {
        console.error(`[${new Date().toISOString()}] Error: Server ID is required for report.`); // Added error log
        return res.status(400).send('Server ID is required.');
    }

    const now = Date.now();
    const existingData = serverDataStore[data.id];

    if (!existingData) {
        // First report for a new server
        const now_date = new Date();
        serverDataStore[data.id] = {
            ...data,
            totalNet: { up: 0, down: 0 },
            resetDay: 1,
            // Record last reset month in `YYYY-M` format
            lastReset: `${now_date.getFullYear()}-${now_date.getMonth() + 1}`, 
            startTime: now,
            lastUpdated: now,
            online: true,
            expirationDate: null, // Initialize expiration date for new server
            cpuModel: data.cpuModel || null, // Initialize cpuModel for new server
            memModel: data.memModel || null, // Initialize memModel for new server
            diskModel: data.diskModel || null // Initialize diskModel for new server
        };
        console.log(`[${new Date().toISOString()}] New server ${data.id} added.`); // Log new server addition
    } else {
        // Update data for existing server
        let upBytesSinceLast = 0;
        let downBytesSinceLast = 0;
        
        // Robustness check for rawTotalNet:
        // If rawTotalNet values decrease (agent reboot), reset accumulated traffic for current period
        if (existingData.rawTotalNet && (data.rawTotalNet.up < existingData.rawTotalNet.up || data.rawTotalNet.down < existingData.rawTotalNet.down)) {
            console.warn(`[${new Date().toISOString()}] Agent for server ${data.id} appears to have rebooted or raw counters reset. Resetting current session traffic accumulation.`);
            // Only add the current reported raw value as the incremental traffic for this specific interval
            upBytesSinceLast = data.rawTotalNet.up;
            downBytesSinceLast = data.rawTotalNet.down;
        } else {
            // Normal operation: calculate difference since last report
            upBytesSinceLast = data.rawTotalNet.up - existingData.rawTotalNet.up;
            downBytesSinceLast = data.rawTotalNet.down - existingData.rawTotalNet.down;
        }

        // Ensure non-negative increments, although the above logic handles most cases
        upBytesSinceLast = Math.max(0, upBytesSinceLast);
        downBytesSinceLast = Math.max(0, downBytesSinceLast);
        
        // Ensure totalNet structure exists before adding
        if (!existingData.totalNet) {
            existingData.totalNet = { up: 0, down: 0 };
        }

        existingData.totalNet.up += upBytesSinceLast;
        existingData.totalNet.down += downBytesSinceLast;

        // Merge new and old data
        serverDataStore[data.id] = {
            ...existingData, // Preserve old settings like totalNet, resetDay, expirationDate etc.
            ...data,         // Overwrite with latest dynamic data from agent report
            totalNet: existingData.totalNet, // Ensure totalNet is not overwritten by spread
            expirationDate: existingData.expirationDate, // Ensure expirationDate is not overwritten by agent data
            cpuModel: data.cpuModel || existingData.cpuModel, // Ensure cpuModel is updated if provided, otherwise preserved
            memModel: data.memModel || existingData.memModel, // Ensure memModel is updated if provided, otherwise preserved
            diskModel: data.diskModel || existingData.diskModel, // Ensure diskModel is updated if provided, otherwise preserved
            lastUpdated: now,
            online: true
        };
        console.log(`[${new Date().toISOString()}] Server ${data.id} updated.`); // Log server update
    }

    saveData(); // Save data
    res.status(200).send('Report received.');
});

// GET /api/servers - Get all server data for the frontend
app.get('/api/servers', (req, res) => {
    console.log(`[${new Date().toISOString()}] Request received for server list.`); // Added log for server list requests
    const now = Date.now();
    // Check online status for all servers
    Object.values(serverDataStore).forEach(server => {
        // If no update for more than 30 seconds, consider offline
        server.online = (now - server.lastUpdated) < 30000; 
    });
    res.json(Object.values(serverDataStore));
});

// POST /api/servers/:id/settings - Update server settings (requires agent installation password)
app.post('/api/servers/:id/settings', (req, res) => {
    const { id } = req.params;
    const { totalNetUp, totalNetDown, resetDay, password, expirationDate } = req.body; // Add password and expirationDate
    
    console.log(`[${new Date().toISOString()}] Received settings update for server ID: ${id}`); // Added log for settings updates

    // Validate agent installation password
    if (!password || password !== AGENT_INSTALL_PASSWORD) {
        console.error(`[${new Date().toISOString()}] Invalid agent installation password for server ${id} settings.`); // Added error log
        return res.status(403).send('Incorrect agent installation password.');
    }

    if (serverDataStore[id]) {
        serverDataStore[id].totalNet.up = totalNetUp;
        serverDataStore[id].totalNet.down = totalNetDown;
        serverDataStore[id].resetDay = resetDay;
        serverDataStore[id].expirationDate = expirationDate; // Save expiration date
        // Note: cpuModel, memModel, diskModel are not updated via settings route, they are only updated by agent reports.
        saveData(); // Save data
        console.log(`[${new Date().toISOString()}] Server ${id} settings updated successfully.`); // Log success
        res.status(200).send('Settings updated successfully.');
    } else {
        console.error(`[${new Date().toISOString()}] Server ${id} not found for settings update.`); // Added error log
        res.status(404).send('Server not found.');
    }
});

// DELETE /api/servers/:id - Delete a server (requires delete password)
app.delete('/api/servers/:id', (req, res) => {
    const { id } = req.params;
    const { password } = req.body;

    console.log(`[${new Date().toISOString()}] Received delete request for server ID: ${id}`); // Added log for delete requests

    if (!password) {
        console.error(`[${new Date().toISOString()}] Password required for deleting server ${id}.`); // Added error log
        return res.status(400).send('Password required.');
    }
    if (password !== DELETE_PASSWORD) {
        console.error(`[${new Date().toISOString()}] Incorrect password for deleting server ${id}.`); // Added error log
        return res.status(403).send('Incorrect password.');
    }

    if (serverDataStore[id]) {
        delete serverDataStore[id];
        saveData(); // Save data
        console.log(`[${new Date().toISOString()}] Server ${id} deleted.`); // Log success
        res.status(200).send('Server deleted successfully.');
    } else {
        console.error(`[${new Date().toISOString()}] Server ${id} not found for deletion.`); // Added error log
        res.status(404).send('Server not found.');
    }
});

// POST /api/verify-agent-password - Verify the agent installation password
app.post('/api/verify-agent-password', (req, res) => {
    const { password } = req.body;
    console.log(`[${new Date().toISOString()}] Received agent password verification request.`); // Added log
    if (password && password === AGENT_INSTALL_PASSWORD) {
        res.status(200).send('Agent installation password correct.');
        console.log(`[${new Date().toISOString()}] Agent installation password verified successfully.`); // Log success
    } else {
        res.status(403).send('Invalid agent installation password.');
        console.warn(`[${new Date().toISOString()}] Invalid agent installation password provided.`); // Log warning
    }
});

// Traffic reset check function - Runs hourly to reset monthly traffic
function checkAndResetTraffic() {
    const now = new Date();
    const currentDay = now.getDate();
    // Use `YYYY-M` format
    const currentMonthYear = `${now.getFullYear()}-${now.getMonth() + 1}`;
    let changed = false;

    console.log(`[${new Date().toISOString()}] Running daily traffic reset check...`);

    Object.keys(serverDataStore).forEach(id => {
        const server = serverDataStore[id];
        // Check if reset day is reached and not yet reset for the current month
        if (server.resetDay === currentDay && server.lastReset !== currentMonthYear) {
            console.log(`[${new Date().toISOString()}] Resetting traffic for server ${id}...`);
            server.totalNet = { up: 0, down: 0 };
            server.lastReset = currentMonthYear;
            changed = true;
        }
    });

    if (changed) {
        console.log(`[${new Date().toISOString()}] Traffic reset complete, saving data...`);
        saveData();
    }
}

// Start the server and set up hourly traffic reset check
app.listen(PORT, '0.0.0.0', () => { 
    console.log(`[${new Date().toISOString()}] Monitor backend server running on http://0.0.0.0:${PORT}`); 
    // Check for traffic reset hourly
    setInterval(checkAndResetTraffic, 1000 * 60 * 60); 
    // Run check immediately on startup
    checkAndResetTraffic();
});
